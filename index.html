<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹å°æ•¸å­¸6ä¸Š-L7 åœ“å‘¨é•·èˆ‡æ‰‡å½¢äº’å‹•æ•™æï¼ˆä¿®å¾©ç‰ˆï¼‰</title>
    <style>
        :root {
            --primary-color: #0ea5e9; /* Sky 500 */
            --primary-dark: #0369a1;
            --accent-color: #f59e0b; /* Amber 500 */
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --bg-color: #f8fafc;
            --text-color: #334155;
            --blue-text: #2563eb;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100dvh; /* ç¢ºä¿æ‰‹æ©Ÿç€è¦½å™¨é«˜åº¦æ­£ç¢º */
            overflow: hidden;
        }

        /* 1. é ‚éƒ¨å°èˆª */
        header {
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 20;
            flex-shrink: 0;
        }

        .nav-group {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 2px;
            scrollbar-width: none;
        }
        .nav-group::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: #e0f2fe;
            border: none;
            color: var(--primary-dark);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: bold;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn.active {
            background: var(--primary-dark);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .nav-btn.challenge-btn {
            background: var(--accent-color);
            color: white;
        }

        /* 2. ä¸­é–“ç•«å¸ƒå€ (è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“) */
        #game-area {
            flex: 1;
            position: relative;
            background: white;
            overflow: hidden;
            border-bottom: 1px solid #e2e8f0;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* æµ®å‹•åœ¨ç•«å¸ƒä¸Šæ–¹çš„æç¤ºå¡ */
        .top-tip {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 15px;
            border-radius: 10px;
            border: 2px solid #cbd5e1;
            font-weight: bold;
            pointer-events: none; 
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 90%;
            text-align: center;
        }

        /* 3. ä¸‹æ–¹æ§åˆ¶å€ (å›ºå®šåœ¨åº•éƒ¨) */
        #controls-area {
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            flex-shrink: 0; 
            z-index: 30;
            min-height: 180px; /* ç¢ºä¿æœ‰è¶³å¤ ç©ºé–“æ”¾æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* æ§åˆ¶é¢æ¿é€šç”¨æ¨£å¼ */
        .panel-content {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* æŒ‰éˆ•èˆ‡æ»‘æ¡¿æ¨£å¼ */
        button.action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #d97706;
            touch-action: manipulation;
        }
        button.action-btn:active { transform: translateY(3px); box-shadow: none; }

        input[type="range"] {
            width: 180px;
            height: 30px; 
            accent-color: var(--primary-color);
        }

        .hidden { display: none !important; }

        /* ç·´ç¿’ä¸­å¿ƒå°ˆç”¨æ¨£å¼ (é·¹æ¶å¼) */
        .topic-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .topic-card {
            background: #f8fafc; border: 2px solid #cbd5e1;
            padding: 15px; border-radius: 10px; text-align: center;
            cursor: pointer;
        }
        .topic-card:active { background: #e0f2fe; border-color: var(--primary-color); }
        
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; color: #64748b; margin-bottom: 5px;
        }

        .concept-box {
            background: #f1f5f9; padding: 8px; border-radius: 6px;
            font-size: 0.95rem; color: #333; margin-bottom: 10px;
            border-left: 4px solid var(--primary-dark);
        }

        .q-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start; }

        /* æ­¥é©Ÿå€å¡Š */
        .step-block {
            background-color: #f8fafc; border: 1px solid #e2e8f0;
            border-left: 4px solid var(--blue-text);
            border-radius: 4px; padding: 8px; margin-top: 5px;
        }
        .step-title { color: var(--blue-text); font-weight: bold; font-size: 0.95rem; margin-bottom: 5px; }
        
        .options-grid { display: flex; gap: 8px; }
        
        .choice-btn {
            flex: 1; padding: 10px; background: white; border: 2px solid #e2e8f0;
            border-radius: 8px; text-align: center; font-size: 0.95rem;
            cursor: pointer;
        }
        .choice-btn.correct { background: #dcfce7; border-color: #16a34a; color: #166534; }
        .choice-btn.wrong { background: #fee2e2; border-color: #ef4444; color: #991b1b; }

        .hint-btn {
            background: #fef3c7; border: 1px solid #f59e0b; color: #92400e;
            padding: 4px 8px; border-radius: 15px; font-size: 0.8rem; cursor: pointer;
        }
        .tts-btn {
            background: none; border: 1px solid #ccc; border-radius: 50%;
            width: 28px; height: 28px; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
        }
        
        .hint-box {
            background: #fffbeb; border: 1px solid #fcd34d; padding: 8px;
            border-radius: 6px; font-size: 0.9rem; color: #92400e; margin-bottom: 5px;
        }

        .practice-link-btn {
            margin-left: 10px; background-color: var(--success-color); color: white;
            border: none; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer;
        }

        /* æ»¾å‹•å®¹å™¨ä¿®å¾© */
        #panel-5 { overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <h1 style="margin:0; font-size:1.2rem; color:#0369a1;">åœ“å‘¨é•·èˆ‡æ‰‡å½¢</h1>
        <div id="score-display" class="hidden" style="font-weight:bold; color:#f59e0b;">å¾—åˆ†: 0</div>
    </div>
    <div class="nav-group">
        <button class="nav-btn active" onclick="app.switchMode(1)">1. åœ“å‘¨ç‡</button>
        <button class="nav-btn" onclick="app.switchMode(2)">2. åœ“å‘¨é•·</button>
        <button class="nav-btn" onclick="app.switchMode(3)">3. æ‰‡å½¢å¼§é•·</button>
        <button class="nav-btn" onclick="app.switchMode(4)">4. æ‰‡å½¢å‘¨é•·</button>
        <button class="nav-btn challenge-btn" onclick="app.switchMode(5)">5. ç·´ç¿’ä¸­å¿ƒ</button>
    </div>
</header>

<!-- ç•«å¸ƒå€ (åªè² è²¬é¡¯ç¤º) -->
<div id="game-area">
    <canvas id="mainCanvas"></canvas>
    <div id="top-tip" class="top-tip">åœ“å‘¨ç‡ $\approx$ 3.14</div>
</div>

<!-- æ§åˆ¶å€ (è² è²¬æ“ä½œï¼Œä¿è­‰å¯é»æ“Š) -->
<div id="controls-area">
    
    <!-- Panel 1: åœ“å‘¨ç‡ -->
    <div id="panel-1" class="panel-content">
        <div class="controls-row">
            <label style="font-size:1.1rem; font-weight:bold;">ç›´å¾‘: <span id="p1-d-val">10</span></label>
            <input type="range" id="p1-slider" min="5" max="15" value="10">
        </div>
        <div class="controls-row">
            <button class="action-btn" onclick="app.act1.roll()">æ»¾å‹•æ¸¬é‡</button>
            <button class="action-btn" style="background:#94a3b8; box-shadow:0 3px 0 #64748b;" onclick="app.act1.reset()">é‡ç½®</button>
        </div>
        <div style="text-align:center; margin-top:5px;">
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(0)">å‰å¾€ç·´ç¿’ >></button>
        </div>
        <div id="p1-res" class="hidden" style="text-align:center; font-weight:bold; color:var(--accent-color); font-size: 1rem;">æ¸¬é‡çµæœ...</div>
    </div>

    <!-- Panel 2: åœ“å‘¨é•· -->
    <div id="panel-2" class="panel-content hidden">
        <div class="controls-row">
            <label style="font-size:1.1rem; font-weight:bold;">åŠå¾‘: <span id="p2-r-val">10</span></label>
            <input type="range" id="p2-slider" min="5" max="20" value="10" step="5">
        </div>
        <div id="p2-formula" style="text-align:center; font-size:1.1rem; font-weight:bold; color:#334155; font-family:monospace;">...</div>
        <div style="text-align:center;">
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(1)">å‰å¾€ç·´ç¿’ >></button>
        </div>
    </div>

    <!-- Panel 3: å¼§é•· -->
    <div id="panel-3" class="panel-content hidden">
        <div class="controls-row">
            <label style="font-size:1.1rem; font-weight:bold;">æ¯”ä¾‹: <span id="p3-frac-val">1/4</span></label>
            <input type="range" id="p3-slider" min="1" max="3" value="1">
        </div>
        <div id="p3-formula" style="text-align:center; font-size:1rem; font-weight:bold; color:#334155; font-family:monospace; white-space: nowrap;">...</div>
        <div style="text-align:center;">
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(2)">å‰å¾€ç·´ç¿’ >></button>
        </div>
    </div>

    <!-- Panel 4: å‘¨é•· -->
    <div id="panel-4" class="panel-content hidden">
        <div class="controls-row">
            <label style="font-size:1.1rem; font-weight:bold;">æ¯”ä¾‹: <span id="p4-frac-val">1/4</span></label>
            <input type="range" id="p4-slider" min="1" max="3" value="1">
        </div>
        <div id="p4-formula" style="text-align:center; font-size:1rem; font-weight:bold; color:#334155; font-family:monospace;">...</div>
        <div style="text-align:center;">
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(3)">å‰å¾€ç·´ç¿’ >></button>
        </div>
    </div>

    <!-- Panel 5: ç·´ç¿’ä¸­å¿ƒ (é·¹æ¶å¼ä½ˆå±€) -->
    <div id="panel-5" class="panel-content hidden">
        
        <!-- é¸å–® -->
        <div id="quiz-menu" class="topic-menu">
            <div class="topic-card" onclick="app.act5.start(0)"><h3>åœ“å‘¨ç‡è§€å¿µ</h3></div>
            <div class="topic-card" onclick="app.act5.start(1)"><h3>åœ“å‘¨é•·è¨ˆç®—</h3></div>
            <div class="topic-card" onclick="app.act5.start(2)"><h3>æ‰‡å½¢å¼§é•·</h3></div>
            <div class="topic-card" onclick="app.act5.start(3)"><h3>æ‰‡å½¢å‘¨é•·</h3></div>
        </div>

        <!-- éŠæˆ²å€ -->
        <div id="quiz-game" class="hidden" style="display:flex; flex-direction:column; height:100%;">
            <div class="quiz-header">
                <span id="quiz-progress">ç¬¬ 1 / 5 é¡Œ</span>
            </div>
            <div class="concept-box" id="concept-text">é‡é»æç¤º</div>

            <div class="q-text">
                <span id="q-text-content" style="flex:1;">é¡Œç›®...</span>
                <div style="display:flex; gap:5px;">
                    <button class="hint-btn" onclick="app.act5.toggleHint()">ğŸ’¡</button>
                    <button class="tts-btn" onclick="app.act5.speakQ()">ğŸ”Š</button>
                </div>
            </div>
            
            <div id="hint-box" class="hint-box hidden"></div>

            <!-- Step 1 -->
            <div class="step-block" id="step1-block">
                <div class="step-title" id="step1-title">â‘  åˆ¤æ–·</div>
                <div class="options-grid" id="step1-options"></div>
            </div>

            <!-- Step 2 -->
            <div class="step-block hidden" id="step2-block">
                <div class="step-title" id="step2-title">â‘¡ è¨ˆç®—</div>
                <div class="options-grid" id="step2-options"></div>
            </div>

            <div class="controls-row hidden" id="next-btn-area" style="margin-top:10px;">
                <button class="action-btn" onclick="app.act5.next()">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <!-- çµç®— -->
        <div id="quiz-result" class="hidden" style="text-align:center;">
            <h2>ç·´ç¿’å®Œæˆï¼</h2>
            <div style="font-size:2.5rem; color:#f59e0b; font-weight:bold;" id="final-score">100</div>
            <p id="session-msg">åšå¾—å¥½ï¼</p>
            <button class="action-btn" onclick="app.act5.menu()">è¿”å›é¸å–®</button>
        </div>
    </div>

</div>

<script>
class App {
    constructor() {
        this.canvas = document.getElementById('mainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = 0; this.height = 0; this.dpr = window.devicePixelRatio || 1;
        
        this.act1 = new ActivityPi(this);
        this.act2 = new ActivityCircumference(this);
        this.act3 = new ActivityArc(this);
        this.act4 = new ActivityPerimeter(this);
        this.act5 = new ActivityQuiz(this);

        this.mode = 1;
        
        window.addEventListener('resize', () => this.resize());
        this.resize();
        this.loop();
    }

    resize() {
        const rect = document.getElementById('game-area').getBoundingClientRect();
        this.width = rect.width;
        this.height = rect.height;
        this.canvas.width = this.width * this.dpr;
        this.canvas.height = this.height * this.dpr;
        this.ctx.scale(this.dpr, this.dpr);
        this.render();
    }

    switchMode(m) {
        this.mode = m;
        document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i+1 === m));
        document.querySelectorAll('.panel-content').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.top-tip').forEach(p => p.classList.add('hidden'));
        
        document.getElementById(`panel-${m}`).classList.remove('hidden');
        document.getElementById('top-tip').classList.remove('hidden');
        
        const tips = ["åœ“å‘¨ç‡ $\\approx$ 3.14", "åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14", "å¼§é•· = åœ“å‘¨é•· Ã— æ¯”ä¾‹", "å‘¨é•· = å¼§é•· + 2åŠå¾‘", "ç·´ç¿’ä¸­å¿ƒ"];
        document.getElementById('top-tip').innerHTML = tips[m-1];
        if(m===5) document.getElementById('top-tip').classList.add('hidden'); // Hide tip in quiz
        
        document.getElementById('score-display').classList.toggle('hidden', m!==5);

        if(m===1) this.act1.reset();
        if(m===2) this.act2.updateUI();
        if(m===3) this.act3.updateUI();
        if(m===4) this.act4.updateUI();
        if(m===5) this.act5.menu();
        
        this.render();
    }

    loop() {
        if(this.mode === 1) this.act1.animate();
        this.render();
        requestAnimationFrame(() => this.loop());
    }

    render() {
        this.ctx.clearRect(0, 0, this.width, this.height);
        if(this.mode === 1) this.act1.draw(this.ctx);
        if(this.mode === 2) this.act2.draw(this.ctx);
        if(this.mode === 3) this.act3.draw(this.ctx);
        if(this.mode === 4) this.act4.draw(this.ctx);
        if(this.mode === 5) this.act5.draw(this.ctx);
    }
}

// 1. åœ“å‘¨ç‡
class ActivityPi {
    constructor(app) { this.app = app; this.d=10; this.p=0; this.rolling=false; 
        document.getElementById('p1-slider').oninput=(e)=>{this.d=parseInt(e.target.value); document.getElementById('p1-d-val').innerText=this.d; this.reset();}
    }
    roll() { if(!this.rolling && this.p<1) {this.rolling=true; document.getElementById('p1-res').classList.add('hidden');} }
    reset() { this.rolling=false; this.p=0; document.getElementById('p1-res').classList.add('hidden'); }
    animate() { 
        if(this.rolling) { 
            this.p += 0.01; 
            if(this.p>=1) {
                this.p=1; this.rolling=false;
                const res = (this.d * 3.14).toFixed(2);
                document.getElementById('p1-res').innerHTML = `ç›´å¾‘ ${this.d} æ»¾ä¸€åœˆ $\\approx$ ${res}`;
                document.getElementById('p1-res').classList.remove('hidden');
            } 
        } 
    }
    draw(ctx) {
        const groundY = this.app.height * 0.7;
        const scale = 12; 
        const startX = 40;
        const rPx = (this.d/2) * scale;
        const totalLen = this.d * 3.14 * scale;
        const curX = startX + this.p * totalLen;

        // Ruler
        ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(this.app.width, groundY); ctx.strokeStyle="#999"; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle="#666"; ctx.textAlign="center"; ctx.font="12px Arial";
        for(let i=0; i<=60; i+=5) {
            let x = startX + i*scale; if(x > this.app.width) break;
            let h = (i%10===0)?15:10;
            ctx.beginPath(); ctx.moveTo(x, groundY); ctx.lineTo(x, groundY+h); ctx.strokeStyle="#999"; ctx.lineWidth=1; ctx.stroke();
            if(i%10===0) ctx.fillText(i, x, groundY+28);
        }

        // Trail
        if(this.p>0) { ctx.beginPath(); ctx.moveTo(startX, groundY); ctx.lineTo(curX, groundY); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=4; ctx.stroke(); }

        // Circle
        ctx.save(); ctx.translate(curX, groundY - rPx); ctx.rotate(curX/rPx);
        ctx.beginPath(); ctx.arc(0,0,rPx,0,Math.PI*2); ctx.fillStyle="rgba(14,165,233,0.3)"; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="#0369a1"; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(rPx,0); ctx.stroke();
        ctx.restore();
    }
}

// 2. åœ“å‘¨é•·
class ActivityCircumference {
    constructor(app) { this.app = app; this.r=10; document.getElementById('p2-slider').oninput=(e)=>{this.r=parseInt(e.target.value); this.updateUI();} }
    updateUI() { 
        document.getElementById('p2-r-val').innerText = this.r;
        document.getElementById('p2-formula').innerText = `ç›´å¾‘(${this.r*2}) Ã— 3.14 = ${(this.r*2*3.14).toFixed(1)}`;
    }
    draw(ctx) {
        const cx=this.app.width/2, cy=this.app.height/2;
        const rPx = this.r * 8;
        ctx.beginPath(); ctx.arc(cx, cy, rPx, 0, Math.PI*2); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=4; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx-rPx, cy); ctx.lineTo(cx+rPx, cy); ctx.strokeStyle="#0369a1"; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle="#000"; ctx.font="16px Arial"; ctx.textAlign="center"; ctx.fillText(`d=${this.r*2}`, cx, cy-10);
    }
}

// 3. å¼§é•· (ä¿®å¾©ç¹¼æ‰¿å•é¡Œ - ç¨ç«‹é¡åˆ¥)
class ActivityArc {
    constructor(app) { 
        this.app=app; this.idx=1; 
        document.getElementById('p3-slider').oninput=(e)=>{ this.idx=parseInt(e.target.value); this.updateUI(); } 
    }
    updateUI() {
        const txts=["1/4","1/2","3/4"], rats=[0.25,0.5,0.75];
        const d=20; // å›ºå®šç›´å¾‘ç‚º 20 ä½œç‚ºç¯„ä¾‹
        const arc = (d * 3.14 * rats[this.idx-1]).toFixed(1);
        document.getElementById('p3-frac-val').innerText = txts[this.idx-1];
        // é¡¯ç¤ºå®Œæ•´åˆ—å¼
        document.getElementById('p3-formula').innerHTML = `å¼§é•· = ${d} Ã— 3.14 Ã— ${txts[this.idx-1]} â‰ˆ ${arc}`;
    }
    draw(ctx) { 
        const cx=this.app.width/2, cy=this.app.height/2;
        const rats=[0.25,0.5,0.75], angle=Math.PI*2*rats[this.idx-1], rPx=80;
        ctx.beginPath(); ctx.arc(cx,cy,rPx,0,Math.PI*2); ctx.strokeStyle="#eee"; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,rPx,0,-angle,true); ctx.closePath(); ctx.fillStyle="rgba(14,165,233,0.2)"; ctx.fill();
        ctx.beginPath(); ctx.arc(cx,cy,rPx,0,-angle,true); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=5; ctx.stroke();
    }
}

// 4. å‘¨é•· (ä¿®å¾©ç¹¼æ‰¿å•é¡Œ - ç¨ç«‹é¡åˆ¥)
class ActivityPerimeter {
    constructor(app) { 
        this.app=app; this.idx=1; 
        document.getElementById('p4-slider').oninput=(e)=>{ this.idx=parseInt(e.target.value); this.updateUI(); } 
    }
    updateUI() {
        const txts=["1/4","1/2","3/4"], rats=[0.25,0.5,0.75];
        const d=20;
        const arc = (d * 3.14 * rats[this.idx-1]);
        document.getElementById('p4-frac-val').innerText = txts[this.idx-1];
        document.getElementById('p4-formula').innerText = `å‘¨é•· â‰ˆ ${arc.toFixed(1)} (å¼§é•·) + ${d} (ç›´å¾‘) = ${(arc+d).toFixed(1)}`;
    }
    draw(ctx) {
        const cx=this.app.width/2, cy=this.app.height/2;
        const rats=[0.25,0.5,0.75], angle=Math.PI*2*rats[this.idx-1], rPx=80;
        ctx.beginPath(); ctx.arc(cx,cy,rPx,0,Math.PI*2); ctx.strokeStyle="#eee"; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,rPx,0,-angle,true); ctx.closePath(); ctx.fillStyle="rgba(14,165,233,0.2)"; ctx.fill();
        ctx.beginPath(); ctx.arc(cx,cy,rPx,0,-angle,true); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=5; ctx.stroke();
        // Radii Highlight
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+rPx,cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(-angle)*rPx, cy+Math.sin(-angle)*rPx); 
        ctx.strokeStyle="#0369a1"; ctx.lineWidth=4; ctx.stroke();
        ctx.fillStyle="#334155"; ctx.font="20px Arial"; ctx.fillText("+", cx+rPx/2, cy-10);
    }
}

// 5. ç·´ç¿’ä¸­å¿ƒ
class ActivityQuiz {
    constructor(app) { this.app=app; this.score=0; this.qIdx=0; this.topic=0; this.sessionScore=0;
        this.topics = [
            { title: "åœ“å‘¨ç‡è§€å¿µ", concept: "åœ“å‘¨ç‡å¤§ç´„æ˜¯ 3.14ã€‚<br>åœ“å‘¨é•· Ã· ç›´å¾‘ = åœ“å‘¨ç‡ã€‚", type: "tf" },
            { title: "åœ“å‘¨é•·è¨ˆç®—", concept: "åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14<br>= åŠå¾‘ Ã— 2 Ã— 3.14", type: "calc_circle" },
            { title: "æ‰‡å½¢å¼§é•·", concept: "å¼§é•· = åœ“å‘¨é•· Ã— å¹¾åˆ†ä¹‹å¹¾", type: "calc_arc" },
            { title: "æ‰‡å½¢å‘¨é•·", concept: "æ‰‡å½¢å‘¨é•· = å¼§é•· + å…©æ¢åŠå¾‘", type: "calc_peri" }
        ];
    }
    startSpecificTopic(id) { this.app.switchMode(5); this.start(id); }
    menu() { 
        document.getElementById('quiz-menu').classList.remove('hidden');
        document.getElementById('quiz-game').classList.add('hidden');
        document.getElementById('quiz-result').classList.add('hidden');
        this.app.updateScore(this.score);
    }
    start(topic) {
        this.topic = topic; this.qIdx = 0; this.sessionScore = 0;
        document.getElementById('quiz-menu').classList.add('hidden');
        document.getElementById('quiz-game').classList.remove('hidden');
        document.getElementById('concept-text').innerHTML = this.topics[this.topic].concept;
        this.next();
    }
    next() {
        if(this.qIdx >= 5) { // End
            document.getElementById('quiz-game').classList.add('hidden');
            document.getElementById('quiz-result').classList.remove('hidden');
            document.getElementById('final-score').innerText = this.sessionScore;
            this.score += this.sessionScore;
            return;
        }
        this.qIdx++;
        this.genQ();
        document.getElementById('next-btn-area').classList.add('hidden');
        document.getElementById('quiz-progress').innerText = `ç¬¬ ${this.qIdx} / 5 é¡Œ`;
        document.getElementById('hint-box').classList.add('hidden');
        document.getElementById('step2-block').classList.add('hidden');
    }
    genQ() {
        const t = this.topics[this.topic].type;
        let qData;
        const rand = (arr) => arr[Math.floor(Math.random()*arr.length)];
        const rNum = () => [1,2,3,4,5,10,20][Math.floor(Math.random()*7)];

        if(t==='tf') {
            const pool=[
                {q:"åœ“å‘¨ç‡æ˜¯å›ºå®šçš„æ•¸ (ç´„3.14)", a:0, h:"å°ï¼Œä¸æœƒéš¨åœ“å¤§å°æ”¹è®Š"},
                {q:"åœ“å‘¨é•·æ˜¯ç›´å¾‘çš„ 2 å€", a:1, h:"æ˜¯3.14å€"},
                {q:"è¨ˆç®—åœ“å‘¨é•·è¦ç”¨ç›´å¾‘", a:0, h:"å…¬å¼ï¼šç›´å¾‘Ã—3.14"}
            ];
            const d = rand(pool);
            qData = { txt: d.q, type: 'tf', s1:{q:"æ•˜è¿°æ˜¯...", o:["æ­£ç¢º","éŒ¯èª¤"], a:d.a}, h:d.h };
        } else if (t==='calc_circle') {
            const r=rNum(), isR=Math.random()>0.5;
            const d=isR?r*2:r;
            qData = {
                txt: `ç®—å‡ºåœ“å‘¨é•· (${isR?'åŠå¾‘':'ç›´å¾‘'} ${isR?r:d})`, type:'circle', r:isR?r:r/2, d:d, showD:!isR,
                s1:{q:"é¡Œç›®çµ¦çš„æ˜¯ï¼Ÿ", o:isR?["ç›´å¾‘","åŠå¾‘"]:["ç›´å¾‘","åŠå¾‘"], a:isR?1:0},
                s2:{q:"ç®—å¼ï¼š", o:isR?[`${r}Ã—3.14`, `${r}Ã—2Ã—3.14`]:[`${d}Ã—3.14`, `${d}Ã—2Ã—3.14`], a:isR?1:0},
                h: isR?"åŠå¾‘è¦å…ˆx2è®Šç›´å¾‘":"ç›´å¾‘ç›´æ¥ä¹˜3.14"
            };
        } else if (t==='calc_arc') {
            const r=rNum(), f=rand([{t:"1/2",v:0.5},{t:"1/4",v:0.25}]);
            qData = {
                txt: `åŠå¾‘ ${r}ï¼Œ${f.t} åœ“çš„å¼§é•·`, type:'sector', r:r, f:f.v,
                s1:{q:"å¹¾åˆ†ä¹‹å¹¾åœ“ï¼Ÿ", o:[f.t, "1"], a:0},
                s2:{q:"ç®—å¼ï¼š", o:[`${r}Ã—2Ã—3.14Ã—${f.t}`, `${r}Ã—3.14Ã—${f.t}`], a:0},
                h: "å…ˆç®—ç›´å¾‘(åŠå¾‘x2)çš„åœ“å‘¨é•·ï¼Œå†ä¹˜æ¯”ä¾‹"
            };
        } else {
            const r=rNum(), f=rand([{t:"1/2",v:0.5},{t:"1/4",v:0.25}]);
            const arc=(r*2*3.14*f.v).toFixed(1);
            qData = {
                txt: `åŠå¾‘ ${r}ï¼Œ${f.t} åœ“çš„æ‰‡å½¢å‘¨é•·`, type:'sector', r:r, f:f.v,
                s1:{q:"å‘¨é•·åŒ…å«ï¼Ÿ", o:["åªæœ‰å¼§é•·","å¼§é•·+2åŠå¾‘"], a:1},
                s2:{q:`ç®—å¼ (å¼§é•·ç´„${arc})`, o:[`${arc}+${r}`, `${arc}+${r*2}`], a:1},
                h: "æ‰‡å½¢å‘¨é•· = å¼§é•· + å…©æ¢åŠå¾‘"
            };
        }
        
        this.currQ = qData;
        document.getElementById('q-text-content').innerText = qData.txt;
        document.getElementById('hint-box').innerText = qData.h;
        
        document.getElementById('step1-title').innerText = "â‘  " + qData.s1.q;
        const s1box = document.getElementById('step1-options');
        s1box.innerHTML = "";
        qData.s1.o.forEach((txt,i) => {
            const btn = document.createElement('div'); btn.className='choice-btn'; btn.innerText=txt;
            btn.onclick = () => this.check(1, i, btn);
            s1box.appendChild(btn);
        });
    }
    check(step, idx, btn) {
        const q = this.currQ;
        const isCorrect = (step===1) ? (idx===q.s1.a) : (idx===q.s2.a);
        const parent = btn.parentElement;
        Array.from(parent.children).forEach(b => b.style.pointerEvents='none');

        if(isCorrect) {
            btn.classList.add('correct');
            this.app.act5.speak("ç­”å°äº†");
            if(step===1 && q.s2) {
                setTimeout(() => {
                    document.getElementById('step2-block').classList.remove('hidden');
                    document.getElementById('step2-title').innerText = "â‘¡ " + q.s2.q;
                    const s2box = document.getElementById('step2-options');
                    s2box.innerHTML = "";
                    q.s2.o.forEach((txt,i) => {
                        const b = document.createElement('div'); b.className='choice-btn'; b.innerText=txt;
                        b.onclick = () => this.check(2, i, b);
                        s2box.appendChild(b);
                    });
                }, 500);
            } else {
                this.sessionScore += 20;
                setTimeout(() => document.getElementById('next-btn-area').classList.remove('hidden'), 500);
            }
        } else {
            btn.classList.add('wrong');
            this.app.act5.speak("å†æƒ³ä¸€æƒ³");
            setTimeout(() => {
                Array.from(parent.children).forEach(b => { b.style.pointerEvents='auto'; b.className='choice-btn'; });
            }, 1000);
        }
    }
    toggleHint() { document.getElementById('hint-box').classList.toggle('hidden'); }
    speakQ() { this.app.act5.speak(this.currQ.txt); }
    speak(txt) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt); u.lang='zh-TW'; window.speechSynthesis.speak(u);
        }
    }
    draw(ctx) {
        if(!this.currQ || !this.currQ.type || this.currQ.type==='tf') return;
        const q = this.currQ;
        const cx=this.app.width/2, cy=this.app.height/2, sc=6;
        ctx.lineWidth=3;
        if(q.type==='circle') {
            const r = q.r*sc;
            ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle="#333"; ctx.stroke(); ctx.fillStyle="#fff"; ctx.fill();
            ctx.beginPath();
            if(q.showD) {
                ctx.setLineDash([5,5]); ctx.moveTo(cx-r,cy); ctx.lineTo(cx+r,cy); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle="#000"; ctx.fillText(`d=${q.d}`, cx, cy-10);
            } else {
                ctx.moveTo(cx,cy); ctx.lineTo(cx+r,cy); ctx.stroke();
                ctx.fillStyle="#000"; ctx.fillText(`r=${q.r}`, cx+10, cy-10);
            }
        } else {
            const r = q.r*sc, ang = Math.PI*2*q.f;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,0,-ang,true); ctx.closePath();
            ctx.strokeStyle="#333"; ctx.stroke(); ctx.fillStyle="#e0f2fe"; ctx.fill();
            ctx.fillStyle="#000"; ctx.fillText(`r=${q.r}`, cx+10, cy+10);
        }
    }
}

const app = new App();
app.updateScore = (s) => { document.getElementById('score-display').innerText = `å¾—åˆ†: ${s}`; }
</script>
</body>
</html>
