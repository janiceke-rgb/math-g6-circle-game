<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹å°æ•¸å­¸6ä¸Š-L7 åœ“å‘¨é•·èˆ‡æ‰‡å½¢äº’å‹•æ•™æï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
    <style>
        :root {
            --primary-color: #0ea5e9; /* Sky 500 */
            --primary-dark: #0369a1;
            --accent-color: #f59e0b; /* Amber 500 */
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --bg-color: #f8fafc;
            --text-color: #334155;
            --green-text: #16a34a; /* Green 600 */
            --blue-text: #2563eb; /* Blue 600 */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Viewport Height for mobile */
        }

        /* å°èˆªåˆ— */
        header {
            background-color: white;
            padding: 8px 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.1rem;
            margin: 0;
            color: var(--primary-dark);
            font-weight: 700;
        }

        .nav-group {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 2px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .nav-group::-webkit-scrollbar { display: none; } /* Chrome/Safari */

        .nav-btn {
            background: #e0f2fe;
            border: none;
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .nav-btn.active {
            background-color: var(--primary-dark);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .nav-btn.challenge-btn {
            background-color: var(--accent-color);
            color: white;
        }

        /* å…§å®¹å€åŸŸå®¹å™¨ (Canvas + Panels) */
        #main-container {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: hidden;
            background-color: #ffffff;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* é ‚éƒ¨æ¦‚å¿µé‡é»é¢æ¿ (æ–°å¢) */
        .top-info-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 600px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 2px solid #94a3b8;
            border-radius: 10px;
            padding: 10px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .concept-tag {
            position: absolute;
            top: -10px;
            left: 10px;
            background: #cbd5e1;
            padding: 2px 8px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 1px solid #94a3b8;
            border-radius: 4px;
            color: #334155;
        }

        .concept-content {
            margin-top: 5px;
            font-size: 1rem;
            line-height: 1.4;
            color: #333;
            text-align: center;
        }

        /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.98);
            padding: 12px 15px;
            border-radius: 16px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            width: 95%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.3s ease;
            border: 1px solid #e2e8f0;
            z-index: 10;
            max-height: 50vh; /* é¿å…è“‹ä½å¤ªå¤š */
            overflow-y: auto;
        }

        /* é€šç”¨æ–‡å­—æ¨£å¼ */
        .text-green { color: var(--green-text); font-weight: bold; }
        .text-blue { color: var(--blue-text); font-weight: bold; }
        .text-accent { color: var(--accent-color); font-weight: bold; }
        .formula-large { font-size: 1.1rem; font-weight: bold; margin: 5px 0; font-family: 'Courier New', monospace; }

        /* ç·´ç¿’é¡Œç›¸é—œ */
        .quiz-area {
            background-color: white;
            /* border: 1px solid #cbd5e1; */
            /* padding: 10px; */
            /* border-radius: 8px; */
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .step-block {
            margin-top: 10px;
            padding: 8px;
            background-color: #f8fafc;
            border-left: 4px solid var(--blue-text);
            border-radius: 4px;
        }

        .step-title {
            color: var(--blue-text);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .options-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .choice-btn {
            flex: 1;
            min-width: 45%;
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .choice-btn:hover { border-color: var(--primary-color); background-color: #f0f9ff; }
        .choice-btn.correct { background-color: #dcfce7; border-color: var(--success-color); color: #166534; }
        .choice-btn.wrong { background-color: #fee2e2; border-color: var(--danger-color); color: #991b1b; }

        .hint-btn {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .hint-box {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            padding: 8px;
            margin-top: 5px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #92400e;
        }

        .tts-btn { background: none; border: 1px solid #ccc; border-radius:50%; width:30px; height:30px; cursor: pointer; font-size: 1rem; display:flex; align-items:center; justify-content:center;}

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        button.action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #d97706;
        }
        button.action-btn:active { transform: translateY(3px); box-shadow: none; }

        .practice-link-btn {
            margin-left: 10px;
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* ç·´ç¿’ä¸­å¿ƒé¸å–® */
        .topic-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .topic-card {
            background: white;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .topic-card:hover { border-color: var(--primary-color); background-color: #f0f9ff; transform: translateY(-2px); }
        .topic-card h3 { margin: 0 0 5px 0; color: var(--primary-dark); font-size: 1rem;}
        .topic-card p { margin: 0; font-size: 0.8rem; color: #64748b; }

        .hidden { display: none !important; }
        input[type="range"] { width: 120px; accent-color: var(--primary-color); height: 24px; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>åœ“å‘¨é•·èˆ‡æ‰‡å½¢å‘¨é•·</h1>
        <div id="score-display" class="hidden" style="font-weight:bold; color:var(--accent-color);">å¾—åˆ†: 0</div>
    </div>
    <div class="nav-group">
        <button class="nav-btn active" onclick="app.switchMode(1)">1. åœ“å‘¨ç‡</button>
        <button class="nav-btn" onclick="app.switchMode(2)">2. åœ“å‘¨é•·</button>
        <button class="nav-btn" onclick="app.switchMode(3)">3. æ‰‡å½¢å¼§é•·</button>
        <button class="nav-btn" onclick="app.switchMode(4)">4. æ‰‡å½¢å‘¨é•·</button>
        <button class="nav-btn challenge-btn" onclick="app.switchMode(5)">5. ç·´ç¿’ä¸­å¿ƒ</button>
    </div>
</header>

<div id="main-container">
    <canvas id="mainCanvas"></canvas>
    
    <!-- === Activity 1: åœ“å‘¨ç‡ === -->
    <!-- é ‚éƒ¨é‡é» -->
    <div id="info-1" class="top-info-panel">
        <div class="concept-tag">åŸºæœ¬æ¦‚å¿µ</div>
        <div class="concept-content">
            <div class="formula-large">åœ“å‘¨é•· Ã· ç›´å¾‘ $\approx$ 3.14</div>
            <div style="font-size:0.9rem; color:#666;">ä¸ç®¡åœ“æ˜¯å¤§æ˜¯å°ï¼Œåœ“å‘¨é•·å¤§ç´„éƒ½æ˜¯ç›´å¾‘çš„ 3 å€å¤šä¸€é»ã€‚</div>
        </div>
    </div>
    <!-- åº•éƒ¨æ§åˆ¶ -->
    <div id="panel-1" class="control-panel">
        <div style="text-align:center; font-weight:bold; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
            å‹•æ‰‹åšï¼šæ»¾å‹•åœ“å½¢
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(0)">å‰å¾€ç·´ç¿’</button>
        </div>
        <div class="controls-row">
            <label>ç›´å¾‘: <span id="p1-d-val">10</span></label>
            <input type="range" id="p1-slider" min="5" max="15" value="10">
            <button class="action-btn" onclick="app.act1.roll()">æ»¾å‹•</button>
            <button class="action-btn" style="background:#94a3b8; box-shadow:0 3px 0 #64748b;" onclick="app.act1.reset()">é‡ç½®</button>
        </div>
        <div id="p1-res" class="hidden" style="text-align:center; margin-top:5px; font-weight:bold; color:var(--accent-color);">æ¸¬é‡çµæœï¼šé•·åº¦ç´„ 31.4 (ç›´å¾‘çš„ 3.14 å€)</div>
    </div>

    <!-- === Activity 2: åœ“å‘¨é•· === -->
    <div id="info-2" class="top-info-panel hidden">
        <div class="concept-tag">åœ“å‘¨é•·å…¬å¼</div>
        <div class="concept-content">
            <div class="formula-large">åœ“å‘¨é•· = <span class="text-green">ç›´å¾‘</span> Ã— 3.14</div>
            <div class="formula-large">åœ“å‘¨é•· = <span class="text-green">åŠå¾‘ Ã— 2</span> Ã— 3.14</div>
        </div>
    </div>
    <div id="panel-2" class="control-panel hidden">
        <div style="text-align:center; font-weight:bold; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
            èª¿æ•´åŠå¾‘è§€å¯Ÿé•·åº¦
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(1)">å‰å¾€ç·´ç¿’</button>
        </div>
        <div class="controls-row">
            <label>åŠå¾‘(r): <span id="p2-r-val">10</span></label>
            <input type="range" id="p2-slider" min="5" max="20" value="10" step="5">
        </div>
        <div id="p2-formula" style="text-align:center; font-family:monospace; margin-top:5px; font-size:1.1rem; font-weight:bold; color:#334155;">...</div>
    </div>

    <!-- === Activity 3: å¼§é•· === -->
    <div id="info-3" class="top-info-panel hidden">
        <div class="concept-tag">æ‰‡å½¢å¼§é•·</div>
        <div class="concept-content">
            <div class="formula-large">å¼§é•· = åœ“å‘¨é•· Ã— å¹¾åˆ†ä¹‹å¹¾</div>
            <div style="font-size:0.9rem;">å…ˆç®—å‡ºå®Œæ•´çš„åœ“å‘¨é•· (ç›´å¾‘Ã—3.14)ï¼Œå†ä¹˜ä¸Šæ¯”ä¾‹ã€‚</div>
        </div>
    </div>
    <div id="panel-3" class="control-panel hidden">
        <div style="text-align:center; font-weight:bold; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
            èª¿æ•´æ‰‡å½¢æ¯”ä¾‹
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(2)">å‰å¾€ç·´ç¿’</button>
        </div>
        <div class="controls-row">
            <label>æ¯”ä¾‹: <span id="p3-frac-val">1/4</span></label>
            <input type="range" id="p3-slider" min="1" max="3" value="1">
        </div>
        <div id="p3-formula" style="text-align:center; font-family:monospace; margin-top:5px; font-weight:bold; color:#334155;">...</div>
    </div>

    <!-- === Activity 4: å‘¨é•· === -->
    <div id="info-4" class="top-info-panel hidden">
        <div class="concept-tag">æ‰‡å½¢å‘¨é•·</div>
        <div class="concept-content">
            <div class="formula-large">æ‰‡å½¢å‘¨é•· = <span class="text-accent">å¼§é•·</span> + <span class="text-blue">å…©æ¢åŠå¾‘</span></div>
            <div style="font-size:0.9rem;">å°±åƒåœç±¬ç¬†ä¸€æ¨£ï¼Œè¦æŠŠå‘¨åœå…¨éƒ¨åœèµ·ä¾†å–”ï¼</div>
        </div>
    </div>
    <div id="panel-4" class="control-panel hidden">
        <div style="text-align:center; font-weight:bold; display:flex; justify-content:center; align-items:center; margin-bottom:5px;">
            è§€å¯Ÿå‘¨ç•Œçš„çµ„æˆ
            <button class="practice-link-btn" onclick="app.act5.startSpecificTopic(3)">å‰å¾€ç·´ç¿’</button>
        </div>
        <div class="controls-row">
            <label>æ¯”ä¾‹: <span id="p4-frac-val">1/4</span></label>
            <input type="range" id="p4-slider" min="1" max="3" value="1">
        </div>
        <div id="p4-formula" style="text-align:center; font-family:monospace; margin-top:5px; font-weight:bold; color:#334155;">...</div>
    </div>

    <!-- === Activity 5: ç·´ç¿’ä¸­å¿ƒ === -->
    <div id="panel-5" class="control-panel hidden">
        <!-- é¸å–® -->
        <div id="quiz-menu-screen">
            <h2 style="text-align:center; margin:0 0 15px 0; color:var(--primary-dark);">é¸æ“‡ç·´ç¿’ä¸»é¡Œ</h2>
            <div class="topic-menu">
                <div class="topic-card" onclick="app.act5.startSpecificTopic(0)">
                    <h3>åœ“å‘¨ç‡è§€å¿µ</h3>
                    <p>æ˜¯éé¡Œåˆ¤æ–·</p>
                </div>
                <div class="topic-card" onclick="app.act5.startSpecificTopic(1)">
                    <h3>åœ“å‘¨é•·è¨ˆç®—</h3>
                    <p>ç›´å¾‘/åŠå¾‘æ··åˆé¡Œ</p>
                </div>
                <div class="topic-card" onclick="app.act5.startSpecificTopic(2)">
                    <h3>æ‰‡å½¢å¼§é•·</h3>
                    <p>æ¯”ä¾‹èˆ‡å¼§é•·è¨ˆç®—</p>
                </div>
                <div class="topic-card" onclick="app.act5.startSpecificTopic(3)">
                    <h3>æ‰‡å½¢å‘¨é•·</h3>
                    <p>å¼§é•·+åŠå¾‘æŒ‘æˆ°</p>
                </div>
            </div>
        </div>

        <!-- éŠæˆ²ä¸­ -->
        <div id="quiz-game-screen" class="hidden">
            <!-- é¡Œç›®æ¨™é¡Œåˆ— -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #eee;">
                <div class="concept-tag" style="position:static; transform:none;" id="quiz-progress">ç¬¬ 1 / 5 é¡Œ</div>
                <div style="font-size:0.9rem; color:#64748b;">æ¦‚å¿µé‡é»</div>
            </div>
            
            <div style="margin-bottom:15px; font-size:0.95rem; color:#333; background:#f1f5f9; padding:8px; border-radius:6px;" id="concept-text">
                <!-- å‹•æ…‹è¼‰å…¥é‡é» -->
            </div>

            <div class="quiz-area">
                <div class="question-text">
                    <span id="q-text" style="flex:1;">é¡Œç›®è¼‰å…¥ä¸­...</span>
                    <div style="display:flex; gap:5px;">
                        <button class="hint-btn" onclick="app.act5.toggleHint()">ğŸ’¡ æç¤º</button>
                        <button class="tts-btn" onclick="app.act5.speakQ()">ğŸ”Š</button>
                    </div>
                </div>
                
                <div id="hint-box" class="hint-box hidden"></div>

                <div class="step-block" id="step1-block">
                    <div class="step-title" id="step1-title">â‘  åˆ¤æ–·</div>
                    <div class="options-grid" id="step1-options"></div>
                </div>

                <div class="step-block hidden" id="step2-block">
                    <div class="step-title" id="step2-title">â‘¡ è¨ˆç®—</div>
                    <div class="options-grid" id="step2-options"></div>
                </div>

                <div class="controls-row hidden" id="next-q-btn" style="margin-top:15px;">
                    <button class="action-btn" onclick="app.act5.nextQuestion()">ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="quiz-result-screen" class="hidden" style="text-align:center; padding:20px;">
            <h2 style="color:var(--primary-dark);">ç·´ç¿’å®Œæˆï¼</h2>
            <p style="font-size:1.2rem; color:#64748b;">æœ¬æ¬¡å¾—åˆ†</p>
            <p style="font-size:3rem; color:var(--accent-color); font-weight:bold; margin:10px 0;" id="session-score">100</p>
            <p id="session-msg" style="margin-bottom:30px; font-size:1.1rem;">åšå¾—å¥½ï¼</p>
            <button class="action-btn" onclick="app.act5.showMenu()">è¿”å›é¸å–®</button>
        </div>
    </div>
</div>

<script>
/**
 * Math Interactive App - Grade 6 Unit 7 (Complete Integrated Version)
 * Fixed layout issues: 
 * 1. Added persistent top info panels for context.
 * 2. Adjusted canvas drawing center to be visible between top/bottom panels.
 */

class App {
    constructor() {
        this.canvas = document.getElementById('mainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = 0; this.height = 0; this.pixelRatio = window.devicePixelRatio || 1;
        
        this.act1 = new ActivityPi(this);
        this.act2 = new ActivityCircumference(this);
        this.act3 = new ActivityArc(this);
        this.act4 = new ActivityPerimeter(this);
        this.act5 = new ActivityQuizCenter(this);

        this.mode = 1;
        window.addEventListener('resize', () => this.resize());
        this.resize();
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    resize() {
        // Container size
        const container = document.getElementById('main-container');
        this.width = container.offsetWidth;
        this.height = container.offsetHeight;
        this.canvas.width = this.width * this.pixelRatio;
        this.canvas.height = this.height * this.pixelRatio;
        this.ctx.scale(this.pixelRatio, this.pixelRatio);
        this.render();
    }

    switchMode(m) {
        this.mode = m;
        document.querySelectorAll('.nav-btn').forEach((b,i) => {
            if(i+1 === m) b.classList.add('active'); else b.classList.remove('active');
        });
        
        // Toggle Panels
        document.querySelectorAll('.control-panel').forEach(p => p.classList.add('hidden'));
        document.querySelectorAll('.top-info-panel').forEach(p => p.classList.add('hidden'));
        
        if (m <= 4) {
            document.getElementById(`panel-${m}`).classList.remove('hidden');
            document.getElementById(`info-${m}`).classList.remove('hidden');
        } else {
            document.getElementById(`panel-5`).classList.remove('hidden');
        }
        
        document.getElementById('score-display').classList.add('hidden');

        if(m===1) this.act1.reset();
        if(m===2) this.act2.updateUI();
        if(m===3) this.act3.updateUI();
        if(m===4) this.act4.updateUI();
        if(m===5) {
            this.act5.showMenu();
            document.getElementById('score-display').classList.remove('hidden');
        }
    }

    loop() { this.update(); this.render(); requestAnimationFrame(this.loop); }
    update() { if(this.mode===1) this.act1.update(); }
    render() {
        this.ctx.clearRect(0,0,this.width,this.height);
        if(this.mode===1) this.act1.draw(this.ctx);
        if(this.mode===2) this.act2.draw(this.ctx);
        if(this.mode===3) this.act3.draw(this.ctx);
        if(this.mode===4) this.act4.draw(this.ctx);
        if(this.mode===5) this.act5.draw(this.ctx);
    }
}

// --- 1. åœ“å‘¨ç‡ (Rolling Circle) ---
class ActivityPi {
    constructor(app){ this.app=app; this.d=10; this.p=0; this.r=false; 
        document.getElementById('p1-slider').oninput=(e)=>{this.d=parseInt(e.target.value); document.getElementById('p1-d-val').innerText=this.d; this.reset();}
    }
    roll(){ if(!this.r && this.p<1) {this.r=true; document.getElementById('p1-res').classList.add('hidden');}}
    reset(){ this.r=false; this.p=0; document.getElementById('p1-res').classList.add('hidden'); }
    update(){ if(this.r){ this.p+=0.015; if(this.p>=1){this.p=1; this.r=false; document.getElementById('p1-res').classList.remove('hidden');}}}
    draw(ctx){
        // Adjusted Y to be vertically centered better
        const groundY = this.app.height * 0.55; 
        const sx=40, sc=15, rpx=(this.d/2)*sc, cx=sx+(this.p*this.d*3.14*sc);
        
        // Ruler
        ctx.beginPath(); ctx.moveTo(0,groundY); ctx.lineTo(this.app.width,groundY); ctx.strokeStyle="#94a3b8"; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle="#64748b"; ctx.font="10px Arial"; ctx.textAlign="center";
        for(let i=0; i<=60; i+=1) {
            let x = sx + i*sc;
            if(x > this.app.width) break;
            let h = 5; if(i%5===0) h=10; if(i%10===0) h=15;
            ctx.beginPath(); ctx.moveTo(x, groundY); ctx.lineTo(x, groundY+h); ctx.strokeStyle="#94a3b8"; ctx.lineWidth=1; ctx.stroke();
            if(i%5===0) ctx.fillText(i, x, groundY+h+12);
        }

        if(this.p>0){ ctx.beginPath(); ctx.moveTo(sx,groundY); ctx.lineTo(cx,groundY); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=4; ctx.stroke(); }
        
        ctx.save(); ctx.translate(cx,groundY-rpx); ctx.rotate((cx-sx)/rpx);
        ctx.beginPath(); ctx.arc(0,0,rpx,0,Math.PI*2); ctx.fillStyle="rgba(14,165,233,0.2)"; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="#0369a1"; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(rpx,0); ctx.stroke(); 
        ctx.beginPath(); ctx.arc(0,0,3,0,Math.PI*2); ctx.fillStyle="#0369a1"; ctx.fill();
        ctx.restore();
        
        // Label start
        ctx.fillStyle = "#334155"; ctx.fillText("0", sx, groundY - 5);
    }
}

// --- 2. åœ“å‘¨é•· (Circumference) ---
class ActivityCircumference {
    constructor(app){ this.app=app; this.r=10; document.getElementById('p2-slider').oninput=(e)=>{this.r=parseInt(e.target.value); this.updateUI();}}
    updateUI(){ 
        const d=this.r*2; document.getElementById('p2-r-val').innerText=this.r; 
        document.getElementById('p2-formula').innerHTML=`ç›´å¾‘=${d}, å‘¨é•·=${d}Ã—3.14=${(d*3.14).toFixed(1)}`;
    }
    draw(ctx){
        const cx=this.app.width/2, cy=this.app.height*0.5, sc=8, rpx=this.r*sc;
        ctx.beginPath(); ctx.arc(cx,cy,rpx,0,Math.PI*2); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=4; ctx.stroke();
        ctx.fillStyle="rgba(14,165,233,0.1)"; ctx.fill();
        ctx.beginPath(); ctx.moveTo(cx-rpx,cy); ctx.lineTo(cx+rpx,cy); ctx.strokeStyle="#0369a1"; ctx.lineWidth=2; ctx.stroke();
        ctx.fillStyle="#0369a1"; ctx.font="bold 16px Arial"; ctx.textAlign="center"; ctx.fillText(`d=${this.r*2}`, cx, cy-10);
    }
}

// --- 3. å¼§é•· (Arc) ---
class ActivityArc {
    constructor(app){ this.app=app; this.idx=1; document.getElementById('p3-slider').oninput=(e)=>{this.idx=parseInt(e.target.value); this.updateUI();}}
    updateUI(){
        const rats=[0.25,0.5,0.75], txts=["1/4","1/2","3/4"], r=10;
        const rat=rats[this.idx-1], txt=txts[this.idx-1];
        document.getElementById('p3-frac-val').innerText=txt;
        document.getElementById('p3-formula').innerHTML=`å¼§é•· = 20 Ã— 3.14 Ã— ${txt} = ${(62.8*rat).toFixed(1)}`;
    }
    draw(ctx){
        const cx=this.app.width/2, cy=this.app.height*0.5, r=100, rats=[0.25,0.5,0.75];
        const ang = Math.PI*2*rats[this.idx-1];
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.strokeStyle = "#e2e8f0"; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,0,-ang,true); ctx.fillStyle="rgba(14,165,233,0.1)"; ctx.fill();
        ctx.beginPath(); ctx.arc(cx,cy,r,0,-ang,true); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=5; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+r,cy); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(-ang)*r, cy+Math.sin(-ang)*r); ctx.lineWidth=1; ctx.strokeStyle="#ccc"; ctx.stroke();
    }
}

// --- 4. å‘¨é•· (Perimeter) ---
class ActivityPerimeter {
    constructor(app){ this.app=app; this.idx=1; document.getElementById('p4-slider').oninput=(e)=>{this.idx=parseInt(e.target.value); this.updateUI();}}
    updateUI(){
        const rats=[0.25,0.5,0.75], txts=["1/4","1/2","3/4"], r=10;
        const rat=rats[this.idx-1], txt=txts[this.idx-1], arc=62.8*rat;
        document.getElementById('p4-frac-val').innerText=txt;
        document.getElementById('p4-formula').innerHTML=`å‘¨é•· = ${(arc).toFixed(1)} + 20 = ${(arc+20).toFixed(1)}`;
    }
    draw(ctx){
        const cx=this.app.width/2, cy=this.app.height*0.5, r=100, rats=[0.25,0.5,0.75];
        const ang = Math.PI*2*rats[this.idx-1];
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,0,-ang,true); ctx.fillStyle="rgba(14,165,233,0.1)"; ctx.fill();
        ctx.beginPath(); ctx.arc(cx,cy,r,0,-ang,true); ctx.strokeStyle="#f59e0b"; ctx.lineWidth=5; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+r,cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(-ang)*r, cy+Math.sin(-ang)*r); 
        ctx.strokeStyle="#0369a1"; ctx.lineWidth=4; ctx.stroke();
        ctx.fillStyle="#334155"; ctx.font="20px Arial"; ctx.fillText("+", cx+r/2, cy-10);
    }
}

// --- 5. é¡Œåº«ç·´ç¿’ä¸­å¿ƒ ---
class ActivityQuizCenter {
    constructor(app) {
        this.app = app;
        this.score = 0;
        this.currentTopic = 0;
        this.currentQ = null;
        this.sessionCount = 0;
        this.maxSession = 5;
        this.topics = [
            { title: "åœ“å‘¨ç‡è§€å¿µ", concept: "åœ“å‘¨ç‡å¤§ç´„æ˜¯ 3.14ã€‚<br>åœ“å‘¨é•· Ã· ç›´å¾‘ = åœ“å‘¨ç‡ã€‚", type: "tf" },
            { title: "åœ“å‘¨é•·è¨ˆç®—", concept: "åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14<br>= åŠå¾‘ Ã— 2 Ã— 3.14", type: "calc_circle" },
            { title: "æ‰‡å½¢å¼§é•·", concept: "å¼§é•· = åœ“å‘¨é•· Ã— å¹¾åˆ†ä¹‹å¹¾", type: "calc_arc" },
            { title: "æ‰‡å½¢å‘¨é•·", concept: "æ‰‡å½¢å‘¨é•· = å¼§é•· + å…©æ¢åŠå¾‘", type: "calc_peri" }
        ];
    }

    startSpecificTopic(topicIdx) {
        this.app.switchMode(5);
        this.currentTopic = topicIdx;
        this.sessionCount = 0;
        this.score = 0;
        this.startGame();
    }

    showMenu() {
        document.getElementById('quiz-menu-screen').classList.remove('hidden');
        document.getElementById('quiz-game-screen').classList.add('hidden');
        document.getElementById('quiz-result-screen').classList.add('hidden');
        this.app.updateScore(this.score);
    }

    startGame() {
        document.getElementById('quiz-menu-screen').classList.add('hidden');
        document.getElementById('quiz-game-screen').classList.remove('hidden');
        document.getElementById('quiz-result-screen').classList.add('hidden');
        document.getElementById('concept-text').innerHTML = this.topics[this.currentTopic].concept;
        this.nextQuestion();
    }

    nextQuestion() {
        this.sessionCount++;
        if (this.sessionCount > this.maxSession) {
            this.showResult();
            return;
        }
        document.getElementById('quiz-progress').innerText = `ç¬¬ ${this.sessionCount} / ${this.maxSession} é¡Œ`;
        this.currentQ = this.generateQuestion();
        this.renderQuestion();
    }

    showResult() {
        document.getElementById('quiz-game-screen').classList.add('hidden');
        document.getElementById('quiz-result-screen').classList.remove('hidden');
        document.getElementById('session-score').innerText = this.score;
        let msg = this.score >= 50 ? "å¤ªæ£’äº†ï¼æ»¿åˆ†ï¼ğŸŒŸ" : (this.score >= 30 ? "è¡¨ç¾ä¸éŒ¯ï¼Œç¹¼çºŒåŠ æ²¹ï¼ğŸ’ª" : "å¤šç·´ç¿’æœƒæ›´é€²æ­¥å–”ï¼ğŸŒ±");
        document.getElementById('session-msg').innerText = msg;
    }

    getRandomNum() {
        const pool = [1,2,3,4,5,6,7,8,9,10,20,30,40,50];
        return pool[Math.floor(Math.random() * pool.length)];
    }

    generateQuestion() {
        const t = this.topics[this.currentTopic].type;
        if (t === "tf") {
            const pool = [
                { q: "åœ“å‘¨ç‡æ˜¯ä¸€å€‹å›ºå®šçš„æ•¸ï¼Œå¤§ç´„æ˜¯ 3.14", ans: true, hint: "æ²’éŒ¯ï¼Œåœ“å‘¨é•·é™¤ä»¥ç›´å¾‘å¤§ç´„æ˜¯3.14" },
                { q: "åœ“å‘¨é•·æ˜¯ç›´å¾‘çš„ 2 å€", ans: false, hint: "æ˜¯ 3.14 å€å–”ï¼" },
                { q: "ä¸ç®¡åœ“å¤šå¤§ï¼Œåœ“å‘¨ç‡éƒ½æ˜¯ 3.14", ans: true, hint: "å°çš„ï¼Œåœ“å‘¨ç‡ä¸æœƒè®Šã€‚" },
                { q: "è¨ˆç®—åœ“å‘¨é•·è¦ç”¨åŠå¾‘ç›´æ¥ä¹˜ä»¥ 3.14", ans: false, hint: "è¦ç”¨ç›´å¾‘(åŠå¾‘x2)å–”ï¼" },
                { q: "ç›´å¾‘è¶Šé•·ï¼Œåœ“å‘¨é•·ä¹Ÿæœƒè¶Šé•·", ans: true, hint: "æ²’éŒ¯ï¼Œå…©è€…æ˜¯ç›¸é—œçš„ã€‚" }
            ];
            const qData = pool[Math.floor(Math.random()*pool.length)];
            return { text: qData.q, type: 'tf', step1: { q: "é€™å¥è©±æ˜¯...", opts: ["æ­£ç¢º (O)", "éŒ¯èª¤ (X)"], correct: qData.ans ? 0 : 1 }, step2: null, hint: qData.hint };
        } 
        else if (t === "calc_circle") {
            const isRadius = Math.random() > 0.5;
            const val = this.getRandomNum();
            const d = isRadius ? val * 2 : val;
            return {
                text: `ç®—å‡ºåœ“å½¢å‘¨é•·ï¼Œ${isRadius ? 'åŠå¾‘' : 'ç›´å¾‘'}æ˜¯ ${val} å…¬åˆ†`,
                type: 'circle', r: isRadius ? val : val/2, d: d, showD: !isRadius,
                step1: { q: "é¡Œç›®çµ¦çš„æ˜¯ç›´å¾‘é‚„æ˜¯åŠå¾‘ï¼Ÿ", opts: isRadius ? ["ç›´å¾‘", "åŠå¾‘"] : ["ç›´å¾‘", "åŠå¾‘"], correct: isRadius ? 1 : 0 },
                step2: { q: "è«‹é¸æ“‡æ­£ç¢ºç®—å¼ï¼š", opts: isRadius ? [`${val} Ã— 3.14`, `${val} Ã— 2 Ã— 3.14`] : [`${val} Ã— 3.14`, `${val} Ã— 2 Ã— 3.14`], correct: isRadius ? 1 : 0 },
                hint: isRadius ? "çµ¦åŠå¾‘è¦å…ˆè®Šç›´å¾‘(x2)å–”ï¼" : "çµ¦ç›´å¾‘ç›´æ¥ä¹˜ 3.14 å³å¯ã€‚"
            };
        }
        else if (t === "calc_arc") {
            const r = this.getRandomNum();
            const fractions = [{ txt: "1/2", val: 0.5 }, { txt: "1/3", val: 1/3 }, { txt: "1/4", val: 0.25 }, { txt: "1/6", val: 1/6 }];
            const f = fractions[Math.floor(Math.random()*fractions.length)];
            return {
                text: `ç®—å‡ºåŠå¾‘ ${r}å…¬åˆ†ï¼Œ${f.txt}åœ“çš„å¼§é•·`,
                type: 'sector', r: r, frac: f.val,
                step1: { q: "é€™æ˜¯å¹¾åˆ†ä¹‹å¹¾åœ“ï¼Ÿ", opts: [`${f.txt} åœ“`, "1 åœ“"], correct: 0 },
                step2: { q: "å¼§é•·ç®—å¼ï¼š", opts: [`${r*2}Ã—3.14Ã—${f.txt}`, `${r}Ã—3.14Ã—${f.txt}`], correct: 0 },
                hint: "è¨˜å¾—å…ˆç®—ç›´å¾‘(åŠå¾‘x2)çš„åœ“å‘¨é•·ï¼Œå†ä¹˜æ¯”ä¾‹ã€‚"
            };
        }
        else if (t === "calc_peri") {
             const r = this.getRandomNum();
             const fractions = [ { txt: "1/2", val: 0.5 }, { txt: "1/4", val: 0.25 } ];
             const f = fractions[Math.floor(Math.random()*fractions.length)];
             const arc = (r * 2 * 3.14 * f.val).toFixed(2);
             return {
                text: `ç®—å‡ºåŠå¾‘ ${r}å…¬åˆ†ï¼Œ${f.txt} åœ“çš„ã€Œæ‰‡å½¢å‘¨é•·ã€`,
                type: 'sector', r: r, frac: f.val,
                step1: { q: "æ‰‡å½¢å‘¨é•·åŒ…å«ä»€éº¼ï¼Ÿ", opts: ["åªæœ‰å¼§é•·", "å¼§é•· + 2æ¢åŠå¾‘"], correct: 1 },
                step2: { q: "æ­£ç¢ºç®—å¼ï¼š", opts: [`${arc} + ${r}`, `${arc} + ${r*2}`], correct: 1 },
                hint: `å¼§é•·ç´„${arc}ï¼Œé‚„è¦åŠ ä¸Šå…©æ¢åŠå¾‘(ç›´å¾‘${r*2})å–”ï¼`
            };
        }
    }

    renderQuestion() {
        const q = this.currentQ;
        document.getElementById('q-text').innerText = q.text;
        document.getElementById('hint-box').classList.add('hidden');
        document.getElementById('hint-box').innerText = q.hint;
        document.getElementById('next-q-btn').classList.add('hidden');
        document.getElementById('step1-title').innerText = q.step1.q;
        this.renderOptions('step1-options', q.step1.opts, (idx) => this.checkStep1(idx));
        document.getElementById('step2-block').classList.add('hidden');
    }

    renderOptions(id, opts, cb) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        opts.forEach((txt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerHTML = `<span>â–¡ ${txt}</span>`;
            btn.onclick = () => cb(idx);
            el.appendChild(btn);
        });
    }

    checkStep1(idx) {
        const q = this.currentQ;
        const btns = document.getElementById('step1-options').children;
        for(let b of btns) b.style.pointerEvents = 'none'; 
        if(idx === q.step1.correct) {
            btns[idx].classList.add('correct'); btns[idx].innerHTML = `<span>â˜‘ ${q.step1.opts[idx]}</span>`;
            this.app.act5.speak("ç­”å°äº†");
            if(q.step2) {
                setTimeout(() => {
                    document.getElementById('step2-block').classList.remove('hidden');
                    document.getElementById('step2-title').innerText = q.step2.q;
                    this.renderOptions('step2-options', q.step2.opts, (i) => this.checkStep2(i));
                }, 800);
            } else { this.finishQuestion(); }
        } else {
            btns[idx].classList.add('wrong'); btns[idx].innerHTML = `<span>â˜’ ${q.step1.opts[idx]}</span>`;
            this.app.act5.speak("å†è©¦è©¦çœ‹");
            setTimeout(() => { for(let b of btns) b.style.pointerEvents = 'auto'; btns[idx].classList.remove('wrong'); btns[idx].innerHTML = `<span>â–¡ ${q.step1.opts[idx]}</span>`; }, 1000);
        }
    }

    checkStep2(idx) {
        const q = this.currentQ;
        const btns = document.getElementById('step2-options').children;
        for(let b of btns) b.style.pointerEvents = 'none';
        if(idx === q.step2.correct) {
            btns[idx].classList.add('correct'); btns[idx].innerHTML = `<span>â˜‘ ${q.step2.opts[idx]}</span>`;
            this.app.act5.speak("å¤ªæ£’äº†");
            this.finishQuestion();
        } else {
            btns[idx].classList.add('wrong'); btns[idx].innerHTML = `<span>â˜’ ${q.step2.opts[idx]}</span>`;
            this.app.act5.speak("å…¬å¼é¸éŒ¯å›‰");
            setTimeout(() => { for(let b of btns) b.style.pointerEvents = 'auto'; btns[idx].classList.remove('wrong'); btns[idx].innerHTML = `<span>â–¡ ${q.step2.opts[idx]}</span>`; }, 1000);
        }
    }

    finishQuestion() {
        this.score += 20;
        this.app.updateScore(this.score);
        setTimeout(() => { document.getElementById('next-q-btn').classList.remove('hidden'); }, 500);
    }

    toggleHint() { document.getElementById('hint-box').classList.toggle('hidden'); }
    speakQ() { this.speak(this.currentQ.text); }
    speak(txt) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt); u.lang = 'zh-TW'; window.speechSynthesis.speak(u);
        }
    }
    updateScore() { document.getElementById('score-display').innerText = `ç¸½åˆ†: ${this.score}`; }

    draw(ctx) {
        if(document.getElementById('quiz-game-screen').classList.contains('hidden')) return;
        const q = this.currentQ;
        if(!q || !q.type || q.type === 'tf') return;

        const cx = this.app.width / 2;
        const cy = this.app.height * 0.35; // Keep quiz visual higher to avoid panel overlap
        const scale = 6; 
        ctx.lineWidth = 3;

        if (q.type === 'circle') {
            const r = q.r * scale;
            ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); 
            ctx.strokeStyle="#333"; ctx.stroke(); ctx.fillStyle="#fff"; ctx.fill();
            ctx.beginPath();
            if(q.showD) {
                ctx.setLineDash([5,5]); ctx.moveTo(cx-r, cy); ctx.lineTo(cx+r, cy); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle="#000"; ctx.font="16px Arial"; ctx.textAlign="center"; ctx.fillText(`d=${q.d}`, cx, cy-10);
            } else {
                ctx.moveTo(cx, cy); ctx.lineTo(cx+r, cy); ctx.stroke();
                ctx.fillStyle="#000"; ctx.font="16px Arial"; ctx.textAlign="center"; ctx.fillText(`r=${q.r}`, cx+r/2, cy-10);
            }
            ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();
        } else if (q.type === 'sector') {
            const r = q.r * scale * 0.8;
            const ang = Math.PI*2*q.frac;
            ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,0,-ang,true); ctx.closePath();
            ctx.strokeStyle="#333"; ctx.stroke(); ctx.fillStyle="#e0f2fe"; ctx.fill();
            ctx.fillStyle="#000"; ctx.fillText(`r=${q.r}`, cx+20, cy+20);
        }
    }
}

const app = new App();
app.updateScore = (s) => { document.getElementById('score-display').innerText = `å¾—åˆ†: ${s}`; }
</script>
</body>
</html>
